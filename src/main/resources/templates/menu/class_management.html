<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>班级管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link th:href="@{/css/management.css}" rel="stylesheet">
</head>
<body>
<!-- 通用header -->
<div th:insert="~{fragments/header :: systemHeader}"></div>

<!-- 侧边栏容器 -->
<div class="sidebar-container">
    <div th:insert="~{fragments/menu :: sidebarMenu}"></div>
</div>

<div class="sub-content" id="contentArea">
    <div class="class-management-container">
        <!-- 页面标题和操作按钮 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-users me-2"></i>班级管理</h2>
            <div class="action-buttons">
                <button class="btn btn-success me-2" onclick="showAddClassForm()">
                    <i class="fas fa-plus me-1"></i>添加新班级
                </button>
                <button class="btn btn-outline-info" onclick="refreshClassData()">
                    <i class="fas fa-sync-alt me-1"></i>刷新数据
                </button>
            </div>
        </div>

        <!-- 统计信息 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h4 th:text="${totalClasses}">0</h4>
                    <p>总班级数</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h4 th:text="${totalStudents}">0</h4>
                    <p>总学生数</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h4 th:text="${activeTeachers}">0</h4>
                    <p>班主任数</p>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card text-center">
                    <h4 th:text="${avgStudentsPerClass}">0</h4>
                    <p>平均学生/班</p>
                </div>
            </div>
        </div>

        <!-- 班级列表 -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">班级列表</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>班级代码</th>
                                <th>班级名称</th>
                                <th>专业</th>
                                <th>年级</th>
                                <th>学生人数</th>
                                <th>班主任</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="classObj : ${classList}">
                                <td th:text="${classObj.classCode}">CS202101</td>
                                <td th:text="${classObj.className}">计算机科学与技术2021级1班</td>
                                <td th:text="${classObj.major}">计算机科学与技术</td>
                                <td th:text="${classObj.grade}">2021</td>
                                <td>
                                    <span class="badge bg-primary" th:text="${classObj.studentCount}">35</span>
                                </td>
                                <td th:text="${classObj.headTeacherName} ?: '未分配'">张教授</td>
                                <td>
                                    <span th:if="${classObj.status == 'ACTIVE'}" class="badge bg-success">活跃</span>
                                    <span th:if="${classObj.status == 'INACTIVE'}" class="badge bg-secondary">未激活</span>
                                </td>
                                <td>
                                    <!-- 修改这里：使用data属性代替直接的事件处理 -->
                                    <button class="btn btn-sm btn-outline-primary me-1 view-class-btn" 
                                            th:attr="data-class-code=${classObj.classCode}">
                                        查看
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning me-1 edit-class-btn" 
                                            th:attr="data-class-id=${classObj.id}">
                                        编辑
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-class-btn" 
                                            th:attr="data-class-id=${classObj.id}">
                                        删除
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 添加/编辑班级的模态框 -->
        <div class="modal fade" id="classModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalTitle">添加新班级</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="classForm">
                            <input type="hidden" id="classId" name="id">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">班级代码 *</label>
                                    <input type="text" class="form-control" id="classCode" name="classCode" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">班级名称 *</label>
                                    <input type="text" class="form-control" id="className" name="className" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">专业 *</label>
                                    <input type="text" class="form-control" id="major" name="major" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">年级 *</label>
                                    <input type="number" class="form-control" id="grade" name="grade" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">院系</label>
                                    <input type="text" class="form-control" id="department" name="department">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">班主任</label>
                                    <select class="form-select" id="headTeacherId" name="headTeacherId">
                                        <option value="">请选择班主任</option>
                                        <option th:each="teacher : ${teachers}" 
                                                th:value="${teacher.id}" 
                                                th:text="${teacher.name}">
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="saveClass()">保存</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/common.js}"></script>
    <script>
        // 页面加载完成后绑定事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定查看班级详情事件
            document.querySelectorAll('.view-class-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const classCode = this.getAttribute('data-class-code');
                    viewClassDetail(classCode);
                });
            });

            // 绑定编辑班级事件
            document.querySelectorAll('.edit-class-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const classId = this.getAttribute('data-class-id');
                    editClass(classId);
                });
            });

            // 绑定删除班级事件
            document.querySelectorAll('.delete-class-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const classId = this.getAttribute('data-class-id');
                    deleteClass(classId);
                });
            });
        });

        // 显示添加班级表单
        function showAddClassForm() {
            document.getElementById('modalTitle').textContent = '添加新班级';
            document.getElementById('classForm').reset();
            document.getElementById('classId').value = '';
            new bootstrap.Modal(document.getElementById('classModal')).show();
        }

        // 编辑班级
        function editClass(classId) {
            // 这里应该通过AJAX获取班级数据
            fetch('/api/class/' + classId)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modalTitle').textContent = '编辑班级';
                    document.getElementById('classId').value = data.id;
                    document.getElementById('classCode').value = data.classCode;
                    document.getElementById('className').value = data.className;
                    document.getElementById('major').value = data.major;
                    document.getElementById('grade').value = data.grade;
                    document.getElementById('department').value = data.department || '';
                    document.getElementById('headTeacherId').value = data.headTeacherId || '';
                    new bootstrap.Modal(document.getElementById('classModal')).show();
                })
                .catch(error => {
                    console.error('获取班级数据失败:', error);
                    alert('获取班级数据失败，请重试');
                });
        }

        // 保存班级
        function saveClass() {
            const formData = new FormData(document.getElementById('classForm'));
            const classData = Object.fromEntries(formData);
            
            const url = classData.id ? '/api/class/update' : '/api/class/add';
            const method = classData.id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(classData)
            })
            .then(response => {
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('classModal')).hide();
                    refreshClassData();
                } else {
                    throw new Error('保存失败');
                }
            })
            .catch(error => {
                console.error('保存班级失败:', error);
                alert('保存失败，请重试');
            });
        }

        // 查看班级详情
        function viewClassDetail(classCode) {
            window.location.href = '/class/detail/' + classCode;
        }

        // 删除班级
        function deleteClass(classId) {
            if (confirm('确定要删除这个班级吗？此操作不可恢复！')) {
                fetch('/api/class/delete/' + classId, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok) {
                        refreshClassData();
                    } else {
                        throw new Error('删除失败');
                    }
                })
                .catch(error => {
                    console.error('删除班级失败:', error);
                    alert('删除失败，请重试');
                });
            }
        }

        // 刷新班级数据
        function refreshClassData() {
            location.reload();
        }
    </script>
</body>
</html>